<?xml version="1.0" encoding="UTF-8"?>
<beans
	xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:security="http://www.springframework.org/schema/security"
	xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.xsd">

<!-- ACEGI配置 -->
<bean id="filterChainProxy" class="org.acegisecurity.util.FilterChainProxy">
	<property name="filterInvocationDefinitionSource">
		<value>
			CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
			PATTERN_TYPE_APACHE_ANT
			/**=httpSessionIntegrationFilter,authenticationProcessingFilter,rememberMeProcessingFilter,exceptionTranslationFilter,filterSecurityInterceptor
		</value>
	</property>
</bean>

<!-- 集成过滤器 -->
<bean id="httpSessionIntegrationFilter" 
	class="org.acegisecurity.context.HttpSessionContextIntegrationFilter" />
	

<!-- 认证处理过滤器 -->
	<!-- 基于表单的身份验证 -->
<bean id="authenticationEntryPoint" class="org.acegisecurity.ui.webapp.AuthenticationProcessingFilterEntryPoint">
	<property name="loginFormUrl" value="/login.jsp"/>
	<property name="forceHttps" value="true"/>
</bean>

<bean id="authenticationProcessingFilter" class="org.acegisecurity.ui.webapp.AuthenticationProcessingFilter">
	<property name="filterProcessesUrl" value="/j_acegi_security_check"/>
	<property name="authenticationFailureUrl" value="/loginfail.jsp"/><!-- 验证失败 -->
	<property name="defaultTargetUrl" value="/LoginAction.action"/>
	<property name="authenticationManager" ref="authenticationManager"/>
</bean>

	<!-- 认证管理器的配置 -->
<bean id="authenticationManager" class="org.acegisecurity.providers.ProviderManager">
	<property name="providers">
		<list>
			<ref bean="daoAuthenticationProvider"/>
			<ref bean="rememberMeAuthenticationProvider" />
		</list>
	</property>
</bean>

<bean id="daoAuthenticationProvider" class="org.acegisecurity.providers.dao.DaoAuthenticationProvider">
	<property name="userDetailsService" ref="userDetailsService"/>
</bean>

<bean id="userDetailsService" class="org.acegisecurity.userdetails.jdbc.JdbcDaoImpl">
	<property name="dataSource" ref="dataSource"/>
 	<property name="usersByUsernameQuery">
		<value>
			SELECT 	username,password,enabled
			FROM 	users
			WHERE 	username = ?
		</value>
	</property>
	<property name="authoritiesByUsernameQuery">
		<value>
			SELECT 	users.username,authorityname
			FROM	users,authority,role,user_role,role_auth
			WHERE	users.username =?
			AND		users.id = user_role.userid
			AND		role.id = user_role.roleid
			AND		role.id = role_auth.roleid
			AND		authority.id = role_auth.authid
		</value>

	</property>
 
</bean>



<!-- 例外转换过滤器 -->
	<!-- 针对AuthenticationException -->
<bean id="exceptionTranslationFilter" class="org.acegisecurity.ui.ExceptionTranslationFilter">
	<property name="authenticationEntryPoint" ref="authenticationEntryPoint"/>
	<property name="accessDeniedHandler" ref="accessDeniedHandler"/>
</bean>

	<!-- 针对AccessDeniedHandleImpl -->
<bean id="accessDeniedHandler" class="org.acegisecurity.ui.AccessDeniedHandlerImpl">
	<property name="errorPage" value="/error/accessDenied.html"/><!-- 权限不够 -->
</bean>



<!-- 过滤器安全拦截器 -->
<bean id="filterSecurityInterceptor" class="org.acegisecurity.intercept.web.FilterSecurityInterceptor">
	<property name="authenticationManager" ref="authenticationManager"/>
	<property name="accessDecisionManager" ref="accessDecisionManager"/>
	<property name="objectDefinitionSource">
		<value>
			CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
			PATTERN_TYPE_APACHE_ANT
			<!-- 权限配置 -->			
  			/admin/*=ROLE_ADMIN
  			
		</value>
	</property>
</bean>

<bean id="accessDecisionManager" class="org.acegisecurity.vote.UnanimousBased">
	<property name="decisionVoters">
		<list>
			<ref bean="roleVoter"/>
		</list>
	</property>
<!--  	<property name="allowIfAllAbstain" value="true"/>-->
</bean>

<bean id="roleVoter" class="org.acegisecurity.vote.RoleVoter">
</bean>


<!-- Remember-Me认证服务 -->
<bean id="rememberMeProcessingFilter" class="org.acegisecurity.ui.rememberme.RememberMeProcessingFilter">
   <property name="authenticationManager"><ref local="authenticationManager"/></property>
   <property name="rememberMeServices"><ref local="rememberMeServices"/></property>
</bean>
   
<bean id="rememberMeServices" class="org.acegisecurity.ui.rememberme.TokenBasedRememberMeServices">
   <property name="userDetailsService"><ref local="userDetailsService"/></property>
   <property name="key"><value>springRocks</value></property>
   <property name="alwaysRemember" value="true"></property>
</bean>

<bean id="rememberMeAuthenticationProvider" class="org.acegisecurity.providers.rememberme.RememberMeAuthenticationProvider">
   <property name="key"><value>springRocks</value></property>
</bean>

<bean id="basicProcessingFilter" 
	class="org.acegisecurity.ui.basicauth.BasicProcessingFilter">
    <property name="authenticationManager" ref="authenticationManager" />
    <property name="authenticationEntryPoint" ref="authenticationEntryPoint" />
    <property name="rememberMeServices" ref="rememberMeServices"></property>
</bean>


<!-- 退出服务 -->
<bean id="logoutFilter" class="org.acegisecurity.ui.logout.LogoutFilter">
   <constructor-arg value="/login.jsp"/>
   <constructor-arg>
      <list>
          <ref local="rememberMeServices" />
          <bean class="org.acegisecurity.ui.logout.SecurityContextLogoutHandler"/>
      </list>
   </constructor-arg>
</bean>


	
</beans>




